#!/bin/bash
# LOCUS - Unified CLI Interface for Project Locus Notification & Context Tracking System
# Enhanced Framework for Multi-Agent Coordination Visibility
#
# Usage: ./locus <command> [options]
# Commands: notify, research, dash, schema, validate, deploy, health, status, help

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AUTOMATION_DIR="$SCRIPT_DIR/automation/scripts"

# Version and metadata
LOCUS_VERSION="1.0.0"
LOCUS_FRAMEWORK="Enhanced Notification & Context Tracking System"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored output
print_header() {
    echo -e "${PURPLE}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║                    LOCUS SYSTEM INTERFACE                         ║${NC}"
    echo -e "${PURPLE}╠════════════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${PURPLE}║ Framework: Enhanced Notification & Context Tracking v${LOCUS_VERSION}        ║${NC}"
    echo -e "${PURPLE}║ Multi-Agent Coordination Visibility System                        ║${NC}"
    echo -e "${PURPLE}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ Error: $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ Warning: $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

# Show help information
show_help() {
    print_header
    cat << EOF
${CYAN}LOCUS Enhanced Notification & Context Tracking Framework${NC}

${YELLOW}USAGE:${NC}
    locus <command> [options]

${YELLOW}CORE NOTIFICATION COMMANDS:${NC}
    ${GREEN}notify${NC} <message>              Generate official system notification
    ${GREEN}research${NC} <topic>             Initiate research and analysis event
    ${GREEN}dash${NC} <update>                Update dashboard and UI components
    ${GREEN}schema${NC} <change>              Modify protocol and structure
    ${GREEN}validate${NC} <target>            Run verification and testing
    ${GREEN}deploy${NC} <component>           Execute production deployment

${YELLOW}MONITORING & CONTEXT COMMANDS:${NC}
    ${GREEN}health${NC}                       Show context health indicators
    ${GREEN}status${NC}                       Generate comprehensive status report
    ${GREEN}trail${NC}                        Show real-time audit trail
    ${GREEN}delta${NC}                        Show context changes visualization
    ${GREEN}timeline${NC}                     Show interactive timeline view
    ${GREEN}receipts${NC}                     List context receipts

${YELLOW}TOOLKIT COMMANDS:${NC}
    ${GREEN}capture${NC} <action> <trigger>   Capture context event with receipt
    ${GREEN}chain${NC} <start_ref> <end_ref>  Validate context chain integrity
    ${GREEN}demo${NC}                         Run comprehensive framework demo

${YELLOW}SYSTEM COMMANDS:${NC}
    ${GREEN}version${NC}                      Show framework version
    ${GREEN}help${NC}                         Show this help message

${YELLOW}EXAMPLES:${NC}
    locus notify "Phase completion notification"
    locus research "Infrastructure migration analysis"
    locus dash "Agent mapping update"
    locus health
    locus status
    locus capture notify "user_request" --changes '{"phase":"complete"}'

${YELLOW}REF TAG FORMAT:${NC}
    LOCUS-[ACTION]-[YYYYMMDD]-[SEQUENCE]
    Examples: LOCUS-NOTIFY-20250911-001, LOCUS-RESEARCH-20250911-002

${YELLOW}CONTEXT RECEIPT SYSTEM:${NC}
    - Immutable audit records with cryptographic validation
    - Generation-time context capture
    - Visual monitoring with real-time updates
    - Multi-agent coordination visibility

For detailed documentation, see: docs/
EOF
}

# Generate system notification
cmd_notify() {
    local message="${1:-Enhanced framework notification}"
    
    print_header
    print_info "Generating Official System Notification..."
    echo ""
    
    # Generate notification using existing framework
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" notify "$message")
    
    # Generate context receipt
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "system_notification" '{"notification_type":"official","message":"'"$message"'"}'
    
    # Show visual notification
    echo ""
    echo "╔════════════════════════════════════════════════════════════════════╗"
    echo "║                    LOCUS SYSTEM NOTIFICATION                       ║"
    echo "╠════════════════════════════════════════════════════════════════════╣"
    printf "║ Reference ID    : %-45s ║\n" "$ref_tag"
    echo "║ Agent Scope     : All Agents (Claude, Perplexity, Lumo)          ║"
    echo "║ System Status   : ACTIVE                                          ║"
    printf "║ Generated       : %-45s ║\n" "$(date -Iseconds)"
    printf "║ Message         : %-45s ║\n" "${message:0:45}"
    echo "╚════════════════════════════════════════════════════════════════════╝"
    
    print_success "System notification generated with REF: $ref_tag"
}

# Research and analysis event
cmd_research() {
    local topic="${1:-Infrastructure analysis}"
    
    print_info "Initiating Research & Analysis Event: $topic"
    
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" research "$topic")
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "research_initiated" '{"research_topic":"'"$topic"'","freshness_required":true}'
    
    # Run freshness validation if available
    if [ -f "$AUTOMATION_DIR/freshness_loop.sh" ]; then
        print_info "Running freshness validation..."
        "$AUTOMATION_DIR/freshness_loop.sh"
    fi
    
    print_success "Research event initiated with REF: $ref_tag"
}

# Dashboard update
cmd_dash() {
    local update="${1:-Dashboard component update}"
    
    print_info "Updating Dashboard Components: $update"
    
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" dash "$update")
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "dashboard_update" '{"dashboard_component":"'"$update"'","ui_refresh":true}'
    
    print_success "Dashboard updated with REF: $ref_tag"
}

# Schema modification
cmd_schema() {
    local change="${1:-Protocol modification}"
    
    print_info "Modifying Schema/Protocol: $change"
    
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" schema "$change")
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "schema_modification" '{"schema_change":"'"$change"'","validation_required":true}'
    
    print_success "Schema modified with REF: $ref_tag"
}

# Validation event
cmd_validate() {
    local target="${1:-System validation}"
    
    print_info "Running Validation Event: $target"
    
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" validate "$target")
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "validation_event" '{"validation_target":"'"$target"'","status":"in_progress"}'
    
    # Run health check
    cmd_health
    
    print_success "Validation completed with REF: $ref_tag"
}

# Deployment event
cmd_deploy() {
    local component="${1:-System component}"
    
    print_info "Executing Deployment: $component"
    
    local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" deploy "$component")
    "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "deployment_event" '{"deployment_component":"'"$component"'","production":true}'
    
    print_success "Deployment executed with REF: $ref_tag"
}

# Context health indicators
cmd_health() {
    print_info "Context Health Indicators"
    echo ""
    
    "$AUTOMATION_DIR/visual_context_monitor.sh" health
    
    # Python health report if available
    if command -v python3 >/dev/null && [ -f "$AUTOMATION_DIR/context_toolkit.py" ]; then
        echo ""
        print_info "Detailed Health Analysis (Python Toolkit)"
        python3 "$AUTOMATION_DIR/context_toolkit.py" validate --health
    fi
}

# Comprehensive status report
cmd_status() {
    print_info "Generating Comprehensive Status Report"
    
    "$AUTOMATION_DIR/status_report.sh"
    
    # Show recent activity
    echo ""
    print_info "Recent Activity Summary"
    cmd_trail
}

# Real-time audit trail
cmd_trail() {
    "$AUTOMATION_DIR/visual_context_monitor.sh" trail
}

# Context changes visualization
cmd_delta() {
    "$AUTOMATION_DIR/visual_context_monitor.sh" delta
}

# Interactive timeline
cmd_timeline() {
    "$AUTOMATION_DIR/visual_context_monitor.sh" timeline
}

# List context receipts
cmd_receipts() {
    print_info "Context Receipts"
    echo ""
    
    if [ -d "/tmp/locus_receipts" ]; then
        local receipt_count=$(ls /tmp/locus_receipts/receipt_*.json 2>/dev/null | wc -l)
        echo "Total receipts: $receipt_count"
        echo ""
        
        if [ "$receipt_count" -gt 0 ]; then
            echo "Recent receipts:"
            ls -lt /tmp/locus_receipts/receipt_*.json | head -5 | while read -r line; do
                local file=$(echo "$line" | awk '{print $9}')
                local ref_tag=$(basename "$file" .json | sed 's/receipt_//')
                local timestamp=$(jq -r '.timestamp' "$file" 2>/dev/null || echo "unknown")
                echo "  $ref_tag ($(date -d "@$timestamp" +"%Y-%m-%d %H:%M" 2>/dev/null || echo "unknown"))"
            done
        else
            echo "No receipts found."
        fi
    else
        echo "Receipt directory not found."
    fi
}

# Capture context event
cmd_capture() {
    local action="${1:-notify}"
    local trigger="${2:-cli_invocation}"
    local changes="${3:-{}}"
    
    print_info "Capturing Context Event: $action"
    
    # Parse changes option
    if [ "${3:-}" = "--changes" ] && [ -n "${4:-}" ]; then
        changes="$4"
    fi
    
    # Use JavaScript toolkit for capture
    if command -v node >/dev/null && [ -f "$AUTOMATION_DIR/context_toolkit.js" ]; then
        node "$AUTOMATION_DIR/context_toolkit.js" "$action" "$trigger" "$changes"
    else
        # Fallback to shell implementation
        local ref_tag=$("$AUTOMATION_DIR/generate_ref_tag.sh" "$action" "$trigger")
        "$AUTOMATION_DIR/generate_context_receipt.sh" "$ref_tag" "$trigger" "$changes"
    fi
}

# Validate context chain
cmd_chain() {
    local start_ref="${1:-}"
    local end_ref="${2:-}"
    
    if [ -z "$start_ref" ] || [ -z "$end_ref" ]; then
        print_error "Usage: locus chain <start_ref> <end_ref>"
        return 1
    fi
    
    print_info "Validating Context Chain: $start_ref -> $end_ref"
    
    # Use Python toolkit for validation
    if command -v python3 >/dev/null && [ -f "$AUTOMATION_DIR/context_toolkit.py" ]; then
        python3 -c "
from context_toolkit import ContextTracker
tracker = ContextTracker()
valid = tracker.validate_context_chain('$start_ref', '$end_ref')
print('✓ Context chain valid' if valid else '✗ Context chain invalid')
"
    else
        print_warning "Python toolkit not available for chain validation"
    fi
}

# Run comprehensive demo
cmd_demo() {
    print_info "Running Comprehensive Framework Demonstration"
    
    "$AUTOMATION_DIR/notification_framework_demo.sh"
}

# Show version
cmd_version() {
    print_header
    echo "Framework Version: $LOCUS_VERSION"
    echo "Implementation: $LOCUS_FRAMEWORK"
    echo ""
    echo "Components:"
    echo "  - REF Tag System: $([ -f "$AUTOMATION_DIR/generate_ref_tag.sh" ] && echo "✓ Available" || echo "✗ Missing")"
    echo "  - Context Receipts: $([ -f "$AUTOMATION_DIR/generate_context_receipt.sh" ] && echo "✓ Available" || echo "✗ Missing")"
    echo "  - Visual Monitoring: $([ -f "$AUTOMATION_DIR/visual_context_monitor.sh" ] && echo "✓ Available" || echo "✗ Missing")"
    echo "  - JavaScript Toolkit: $([ -f "$AUTOMATION_DIR/context_toolkit.js" ] && echo "✓ Available" || echo "✗ Missing")"
    echo "  - Python Toolkit: $([ -f "$AUTOMATION_DIR/context_toolkit.py" ] && echo "✓ Available" || echo "✗ Missing")"
    echo "  - Status Reporting: $([ -f "$AUTOMATION_DIR/status_report.sh" ] && echo "✓ Available" || echo "✗ Missing")"
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    
    # Shift past the command
    shift 2>/dev/null || true
    
    case "$command" in
        "notify")
            cmd_notify "$@"
            ;;
        "research")
            cmd_research "$@"
            ;;
        "dash"|"dashboard")
            cmd_dash "$@"
            ;;
        "schema")
            cmd_schema "$@"
            ;;
        "validate")
            cmd_validate "$@"
            ;;
        "deploy")
            cmd_deploy "$@"
            ;;
        "health")
            cmd_health "$@"
            ;;
        "status")
            cmd_status "$@"
            ;;
        "trail")
            cmd_trail "$@"
            ;;
        "delta")
            cmd_delta "$@"
            ;;
        "timeline")
            cmd_timeline "$@"
            ;;
        "receipts")
            cmd_receipts "$@"
            ;;
        "capture")
            cmd_capture "$@"
            ;;
        "chain")
            cmd_chain "$@"
            ;;
        "demo")
            cmd_demo "$@"
            ;;
        "version")
            cmd_version "$@"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            echo "Use 'locus help' for available commands."
            exit 1
            ;;
    esac
}

# Check if script directory exists
if [ ! -d "$AUTOMATION_DIR" ]; then
    print_error "Automation scripts directory not found: $AUTOMATION_DIR"
    exit 1
fi

# Execute main function
main "$@"